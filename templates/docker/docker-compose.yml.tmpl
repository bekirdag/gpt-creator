# docker-compose.yml template for gpt-creator stack (API, web, admin, db, proxy)
services:
  db:
    image: mysql:8.0
    container_name: {{PROJECT_SLUG}}-db
    mem_limit: 1536m
    mem_reservation: 1g
    environment:
      MYSQL_ROOT_PASSWORD: {{DB_ROOT_PASSWORD}}
      MYSQL_ROOT_HOST: '%'
      MYSQL_DATABASE: {{DB_NAME}}
      MYSQL_USER: {{DB_USER}}
      MYSQL_PASSWORD: {{DB_PASSWORD}}
    ports:
      - "{{DB_HOST_PORT}}:3306"
    healthcheck:
      test:
        - CMD-SHELL
        - MYSQL_PWD="$${MYSQL_ROOT_PASSWORD:-}" mysqladmin ping -h 127.0.0.1 -uroot --silent
      interval: 5s
      timeout: 3s
      retries: 30
    volumes:
      - db_data:/var/lib/mysql

  api:
    build:
      context: ..
      dockerfile: docker/Dockerfile.api
    container_name: {{PROJECT_SLUG}}-api
    mem_limit: 1024m
    mem_reservation: 512m
    depends_on:
      db:
        condition: service_healthy
    environment:
      NODE_ENV: development
      DATABASE_URL: mysql://{{DB_USER}}:{{DB_PASSWORD}}@db:3306/{{DB_NAME}}
      PORT: 3000
      GC_SERVICE: api
    entrypoint:
      - /usr/local/bin/pnpm-entry.sh
    command:
      - cd /workspace/apps/api && pnpm run start:dev
    ports:
      - "3000:3000"
    volumes:
      - ..:/workspace
      - pnpm_store:/var/pnpm-store

  web:
    build:
      context: ..
      dockerfile: docker/Dockerfile.web
    container_name: {{PROJECT_SLUG}}-web
    mem_limit: 768m
    mem_reservation: 384m
    environment:
      NODE_ENV: development
      VITE_API_BASE: ${VITE_API_BASE:-http://localhost:3000/api/v1}
      GC_SERVICE: web
    entrypoint:
      - /usr/local/bin/pnpm-entry.sh
    command:
      - cd /workspace/apps/web && pnpm run dev -- --host 0.0.0.0
    ports:
      - "5173:5173"
    volumes:
      - ..:/workspace
      - pnpm_store:/var/pnpm-store

  admin:
    build:
      context: ..
      dockerfile: docker/Dockerfile.admin
    container_name: {{PROJECT_SLUG}}-admin
    mem_limit: 768m
    mem_reservation: 384m
    environment:
      NODE_ENV: development
      VITE_API_BASE: ${VITE_API_BASE:-http://localhost:3000/api/v1}
      GC_SERVICE: admin
    entrypoint:
      - /usr/local/bin/pnpm-entry.sh
    command:
      - cd /workspace/apps/admin && pnpm run dev -- --host 0.0.0.0
    ports:
      - "5174:5173"
    volumes:
      - ..:/workspace
      - pnpm_store:/var/pnpm-store

  proxy:
    image: nginx:alpine
    container_name: {{PROJECT_SLUG}}-proxy
    mem_limit: 256m
    mem_reservation: 128m
    depends_on:
      - web
      - admin
      - api
    ports:
      - "8080:80"
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf:ro

volumes:
  db_data: {}
  pnpm_store: {}
